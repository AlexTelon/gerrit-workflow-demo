<?xml version='1.0' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@1.10">
  <actions/>
  <description>Main workflow build!</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.branch.RateLimitBranchProperty_-JobPropertyImpl plugin="branch-api@0.2-beta-4">
      <durationName>hour</durationName>
      <count>0</count>
    </jenkins.branch.RateLimitBranchProperty_-JobPropertyImpl>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@1.10">
    <script>// Run this with mvn args on each node
def mvn(args) {
    sh &quot;${tool &apos;Maven 3.x&apos;}/bin/mvn ${args}&quot;
}

def fetch_repo() {
    sh &apos;repo init -u http://gerrit:8080/umbrella -m jenkins.xml&apos;  // --repo-url=http://gerrit:8080/static/repo.bundle
    sh &apos;repo sync&apos;
//    sh &quot;repo download $GERRIT_PROJECT $GERRIT_CHANGE_NUMBER/$GERRIT_PATCHSET_NUMBER&quot;
}

// TOOD patchset use
// TODO supply branch name to script for easy customization

def builds = [:]
builds[&apos;workflowrun&apos;] =  {
  stage &apos;building&apos;
  node {
    sh &apos;rm -rf source || true&apos;
    // Remove dir component in 1.11
    dir (&apos;source&apos;) {
      fetch_repo()
      mvn(&quot;clean compile install -f primary/pom.xml&quot;)
      mvn(&quot;clean compile install -Dmaven.test.skip -f secondary/pom.xml&quot;)
      sh &quot;mv */target/*.jar .&quot;
      stash includes: &apos;*.jar&apos;, name: &apos;jars&apos;
    }
  }

  def slowtests = [:]
  slowtests[&apos;Fuctional Tests&apos;] = {
    node {
     unstash name:&apos;jars&apos;
     sleep 2

     // Verify the jars can run successfully
     sh &apos;java -jar primary*.jar -delay 1 --length 100&apos;
     sh &apos;java -jar secondary*.jar&apos;
     // Fetch both artifacts
     // Run both jar artifacts
     echo &apos;doing test1 for env 1&apos;
    }
  }
  slowtests[&apos;Integration tests&apos;] = {
    node {
      sleep 15
      unstash name:&apos;jars&apos;
      sh &apos;java -jar primary*.jar `java -jar secondary*.jar`&apos;
    }
  }
  parallel slowtests
}

// PARALLEL BUILD STEP
builds[&apos;freestylebuild&apos;] = {
  stage &apos;building&apos;
  node {
    fetch_repo()
    sleep 30
    mvn(&quot;clean compile install -Dmaven.test.skip -f primary/pom.xml&quot;)
    mvn(&quot;clean compile install -Dmaven.test.skip -f secondary/pom.xml&quot;)
  }
}

parallel builds</script>
    <sandbox>false</sandbox>
  </definition>
  <triggers>
    <com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.GerritTrigger plugin="gerrit-trigger@2.15.0">
      <spec></spec>
      <gerritProjects>
        <com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.data.GerritProject>
          <compareType>PLAIN</compareType>
          <pattern>primary</pattern>
          <branches>
            <com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.data.Branch>
              <compareType>PLAIN</compareType>
              <pattern></pattern>
            </com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.data.Branch>
          </branches>
        </com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.data.GerritProject>
      </gerritProjects>
      <skipVote>
        <onSuccessful>false</onSuccessful>
        <onFailed>false</onFailed>
        <onUnstable>false</onUnstable>
        <onNotBuilt>false</onNotBuilt>
      </skipVote>
      <silentMode>false</silentMode>
      <notificationLevel></notificationLevel>
      <silentStartMode>false</silentStartMode>
      <escapeQuotes>true</escapeQuotes>
      <noNameAndEmailParameters>false</noNameAndEmailParameters>
      <dependencyJobsNames></dependencyJobsNames>
      <readableMessage>false</readableMessage>
      <buildStartMessage></buildStartMessage>
      <buildFailureMessage></buildFailureMessage>
      <buildSuccessfulMessage></buildSuccessfulMessage>
      <buildUnstableMessage></buildUnstableMessage>
      <buildNotBuiltMessage></buildNotBuiltMessage>
      <customUrl></customUrl>
      <serverName>__ANY__</serverName>
      <triggerOnEvents>
        <com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.events.PluginPatchsetCreatedEvent>
          <excludeDrafts>false</excludeDrafts>
          <excludeTrivialRebase>false</excludeTrivialRebase>
          <excludeNoCodeChange>false</excludeNoCodeChange>
        </com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.events.PluginPatchsetCreatedEvent>
      </triggerOnEvents>
      <dynamicTriggerConfiguration>false</dynamicTriggerConfiguration>
      <triggerConfigURL></triggerConfigURL>
      <triggerInformationAction/>
    </com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.GerritTrigger>
  </triggers>
</flow-definition>